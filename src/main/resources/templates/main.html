<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head
	th:replace="~{parts/admin-common :: html_head('管理者トップ - さわやか医院予約システム')}"></head>
<body class="bg-light text-dark">
	<div class="d-flex flex-column min-vh-100 bg-light">
		<div th:replace="~{parts/admin-common :: header()}"></div>
		<main class="container flex-grow-1 py-5">
			<div class="row justify-content-center">
				<div class="col-12 col-md-10 col-lg-9">
					<div class="row g-0 shadow-sm"
						style="border-radius: 1.5rem; overflow: hidden; background: #fff;">
						<!-- カレンダー -->
						<div class="col-md-6 border-end" style="background: #f9fbfe;">
							<div class="p-4 h-100">
								<h5 class="mb-4 text-center" style="font-weight: bold;">予約カレンダー</h5>
								<div id="calendar"></div>
							</div>
						</div>
						<!-- タイムテーブル -->
						<div
							class="col-md-6 d-flex align-items-center justify-content-center"
							style="padding: 2rem;">
							<div class="w-100">
								<h5 id="selected-date-title" class="mb-4 text-center"
									style="font-weight: bold;">選択した日付の予約タイムテーブル</h5>
								<table class="table table-bordered" id="timetable">
									<thead></thead>
									<tbody></tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- JS/CSSリソース -->
			<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
			<link rel="stylesheet"
				href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
			<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
			<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
			<script>
				flatpickr("#calendar", {
					inline : true,
					dateFormat : "Y-m-d",
					locale : "ja",
					defaultDate : new Date(),
					onChange : function(selectedDates, dateStr) {
						fetchAppointments(dateStr);
					}
				});

				$(document).ready(function() {
					const today = new Date().toISOString().slice(0, 10);
					fetchAppointments(today);
				});

				// 縦並びでタイムテーブルを描画
				function renderTimetable(data) {
					let thead = "<tr><th>時間枠</th><th>予約情報</th></tr>";
					let tbody = "";
					data
							.forEach(function(slot) {
								tbody += "<tr>";
								tbody += `<td>${slot.timeLabel}</td>`;
								if (slot.patientName) {
									tbody += `<td>${slot.patientName} (${slot.cardNumber})<br>${slot.phoneNumber}</td>`;
								} else {
									tbody += "<td></td>";
								}
								tbody += "</tr>";
							});
					$("#timetable thead").html(thead);
					$("#timetable tbody").html(tbody);
				}

				function fetchAppointments(dateStr) {
					$("#selected-date-title").text(dateStr + "の予約タイムテーブル");
					$.ajax({
						url : "/admin/appointments",
						type : "GET",
						data : {
							date : dateStr
						},
						success : function(data) {
							renderTimetable(data);
						},
						error : function() {
							$("#timetable thead").html("");
							$("#timetable tbody").html(
									"<tr><td colspan='2'>取得エラー</td></tr>");
						}
					});
				}
			</script>
		</main>
		<div th:replace="~{parts/admin-common :: footer()}"></div>
	</div>
</body>
</html>