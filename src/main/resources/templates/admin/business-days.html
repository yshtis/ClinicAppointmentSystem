<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head
	th:replace="~{parts/admin-common.html :: html_head('営業日設定 - さわやか医院予約システム')}"></head>
<body class="bg-light text-dark">
	<div class="d-flex flex-column min-vh-100 bg-light">
		<header th:replace="~{parts/admin-common.html :: header()}"></header>
		<main class="container flex-grow-1 py-4">
			<div class="row justify-content-center">
				<div class="col-12 col-md-10 col-lg-8">
					<div class="shadow-sm"
						style="border-radius: 1.5rem; overflow: hidden; background: #fff;">
						<div class="row g-0">
							<div class="col-12">
								<h2 class="mb-0 py-3 text-center fw-bold">営業日設定</h2>
								<hr class="my-0">
							</div>
						</div>
						<div class="row g-0">
							<div class="col-12">
								<div class="p-4">
									<div class="mb-4 text-end">
										<a href="/admin/main" class="btn btn-outline-primary">予約一覧へ戻る</a>
									</div>

									<!-- メッセージ表示 -->
									<div th:if="${message != null}"
										class="alert alert-success alert-dismissible fade show"
										role="alert">
										<strong>成功:</strong> <span th:text="${message ?: ''}"></span>
										<button type="button" class="btn-close"
											data-bs-dismiss="alert"></button>
									</div>
									<div th:if="${error != null}"
										class="alert alert-danger alert-dismissible fade show"
										role="alert">
										<strong>エラー:</strong> <span th:text="${error ?: ''}"></span>
										<button type="button" class="btn-close"
											data-bs-dismiss="alert"></button>
									</div>

									<!-- 営業日追加フォーム -->
									<div class="card mb-4">
										<div class="card-header bg-primary text-white">
											<strong>新しい営業日を追加</strong>
										</div>
										<div class="card-body">
											<form th:action="@{/admin/business-days/add}" method="post">
												<div class="row g-3 align-items-end">
													<div class="col-md-6">
														<label for="date" class="form-label">営業日</label> <input
															type="date" id="date" name="date" class="form-control"
															required
															th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
														<div class="form-text">今日以降の日付を選択してください</div>
													</div>
													<div class="col-md-3">
														<label for="businessType" class="form-label">営業形態</label>
														<select id="businessType" name="businessType"
															class="form-select">
															<option value="allday" selected>終日営業</option>
															<option value="am">午前営業</option>
															<option value="pm">午後営業</option>
														</select>
													</div>
													<div class="col-md-3">
														<button type="submit" class="btn btn-primary w-100">営業日を追加</button>
													</div>
												</div>
												<input type="hidden" th:name="${_csrf?.parameterName}"
													th:value="${_csrf?.token}" />
											</form>
										</div>
									</div>

									<!-- 営業日一覧 -->
									<div class="card">
										<div
											class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
											<strong>営業日一覧</strong> <span class="badge bg-light text-dark"
												th:text="${businessDays != null ? #lists.size(businessDays) : 0} + '件'">0件</span>
										</div>
										<div class="card-body p-0">
											<div class="table-responsive">
												<table class="table table-hover mb-0">
													<thead class="table-light">
														<tr>
															<th width="30%">日付</th>
															<th width="20%">営業形態</th>
															<th width="15%">状態</th>
															<th width="35%" class="text-center">操作</th>
														</tr>
													</thead>
													<tbody>
														<tr th:each="day : ${businessDays}"
															th:if="${businessDays != null}">
															<td><strong
																th:text="${day?.businessDateAsLocalDate != null ? #temporals.format(day.businessDateAsLocalDate, 'yyyy/MM/dd (E)') : ''}"></strong></td>
															<td><span class="badge"
																th:class="'badge ' + ${day?.getBusinessTypeButtonClass() ?: ''}"
																th:text="${day?.getBusinessTypeDisplayName() ?: ''}"></span>
															</td>
															<td><span th:if="${day?.isActive}"
																class="badge bg-success">営業中</span> <span
																th:if="${day != null && !day.isActive}"
																class="badge bg-secondary">休業</span></td>
															<td class="text-center">
																<div class="btn-group" role="group">
																	<!-- 営業形態切り替えボタン -->
																	<div class="dropdown">
																		<button
																			class="btn btn-outline-info btn-sm dropdown-toggle"
																			type="button" data-bs-toggle="dropdown">
																			営業形態</button>
																		<ul class="dropdown-menu">
																			<li
																				th:each="type : ${#arrays.asList('allday','am','pm')}">
																				<form
																					th:action="@{/admin/business-days/update-type}"
																					method="post" style="display: inline;">
																					<input type="hidden" name="id"
																						th:value="${day?.id}" /> <input type="hidden"
																						name="businessType" th:value="${type}" /> <input
																						type="hidden" th:name="${_csrf?.parameterName}"
																						th:value="${_csrf?.token}" />
																					<button type="submit" class="dropdown-item"
																						th:class="${day?.businessType == type ? 'dropdown-item active' : 'dropdown-item'}"
																						th:text="${type == 'allday' ? '終日営業' : (type == 'am' ? '午前営業' : '午後営業')}"></button>
																				</form>
																			</li>
																		</ul>
																	</div>

																	<!-- 状態切り替え -->
																	<form th:action="@{/admin/business-days/toggle}"
																		method="post" style="display: inline;">
																		<input type="hidden" name="id" th:value="${day?.id}" />
																		<input type="hidden" th:name="${_csrf?.parameterName}"
																			th:value="${_csrf?.token}" />
																		<button type="submit"
																			th:class="'btn btn-sm ' + ${day?.getToggleButtonClass() ?: ''}"
																			th:text="${day?.getToggleButtonText() ?: ''}"
																			onclick="return confirm('営業状態を変更しますか？');"></button>
																	</form>

																	<!-- 削除 -->
																	<form th:action="@{/admin/business-days/delete}"
																		method="post" style="display: inline;">
																		<input type="hidden" name="id" th:value="${day?.id}" />
																		<input type="hidden" th:name="${_csrf?.parameterName}"
																			th:value="${_csrf?.token}" />
																		<button type="submit" class="btn btn-danger btn-sm"
																			onclick="return confirm('本当に削除しますか？この操作は取り消せません。');">削除</button>
																	</form>
																</div>
															</td>
														</tr>
														<tr
															th:if="${businessDays == null or #lists.isEmpty(businessDays)}">
															<td colspan="4" class="text-center text-muted py-4">
																<div class="empty-state">
																	<p class="empty-message">営業日が登録されていません</p>
																	<small>上記フォームから営業日を追加してください</small>
																</div>
															</td>
														</tr>
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
								<!-- /p-4 -->
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
		<footer th:replace="~{parts/admin-common.html :: footer()}"></footer>
	</div>
	<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
